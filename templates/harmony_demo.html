<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HARMONY Prompt Explorer | OpenAI</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f7f7f8;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Header Styles */
        .app-header {
            background: #ffffff;
            border-bottom: 1px solid #e5e5e5;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .openai-logo {
            width: 24px;
            height: 24px;
            color: #000;
        }
        
        .app-title {
            font-size: 20px;
            font-weight: 600;
            color: #000;
            margin: 0;
            letter-spacing: -0.02em;
        }
        
        .beta-badge {
            background: #10a37f;
            color: white;
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .header-right {
            display: flex;
            gap: 8px;
        }
        
        .header-button {
            background: transparent;
            border: 1px solid #e5e5e5;
            color: #353740;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .header-button:hover {
            background: #f7f7f8;
            border-color: #d9d9e3;
        }
        
        .header-button svg {
            width: 16px;
            height: 16px;
        }
        
        body.dark-mode .app-header {
            background: #202123;
            border-bottom-color: #353740;
        }
        
        body.dark-mode .openai-logo {
            color: #fff;
        }
        
        body.dark-mode .app-title {
            color: #fff;
        }
        
        body.dark-mode .header-button {
            color: #ececf1;
            border-color: #353740;
        }
        
        body.dark-mode .header-button:hover {
            background: #2a2b32;
            border-color: #565869;
        }
        
        /* Dark mode styles */
        body.dark-mode {
            color: #e0e0e0;
            background-color: #1a1a1a;
        }
        
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode h3,
        body.dark-mode h4 {
            color: #f0f0f0;
        }
        
        body.dark-mode .subtitle {
            color: #b0b0b0;
        }
        
        body.dark-mode .panel {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .panel h2 {
            color: #f0f0f0;
        }
        
        body.dark-mode label {
            color: #d0d0d0;
        }
        
        body.dark-mode input[type="text"],
        body.dark-mode input[type="date"],
        body.dark-mode input[type="number"],
        body.dark-mode select,
        body.dark-mode textarea {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            color: #e0e0e0;
        }
        
        body.dark-mode input[type="text"]:focus,
        body.dark-mode input[type="date"]:focus,
        body.dark-mode input[type="number"]:focus,
        body.dark-mode select:focus,
        body.dark-mode textarea:focus {
            border-color: #5a5a5a;
            outline: none;
        }
        
        body.dark-mode .code-display {
            background: #1e1e1e;
            border: 1px solid #3a3a3a;
            color: #e0e0e0;
        }
        
        body.dark-mode .special-token {
            color: #4db8ff;
            background: #1a3a52;
        }
        
        body.dark-mode .channel-analysis {
            background: #3a3a1a;
            border-left-color: #ffcc00;
            color: #e0e0e0;
        }
        
        body.dark-mode .channel-commentary {
            background: #1a2a3a;
            border-left-color: #4db8ff;
            color: #e0e0e0;
        }
        
        body.dark-mode .channel-final {
            background: #1a3a2a;
            border-left-color: #4dff88;
            color: #e0e0e0;
        }
        
        body.dark-mode button {
            background: #4a4a4a;
            color: #f0f0f0;
        }
        
        body.dark-mode button:hover {
            background: #5a5a5a;
        }
        
        body.dark-mode button:disabled {
            background: #2a2a2a;
            color: #6a6a6a;
        }
        
        body.dark-mode .message {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .message-header {
            color: #b0b0b0;
            border-bottom-color: #3a3a3a;
        }
        
        body.dark-mode .message-content {
            color: #e0e0e0;
        }
        
        body.dark-mode .tool-definition {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
        }
        
        body.dark-mode .token-display {
            background: #1e1e1e;
            border: 1px solid #3a3a3a;
        }
        
        body.dark-mode .token-item {
            background: #3a3a3a;
            color: #e0e0e0;
        }
        
        /* Dark mode for browser warning dialog */
        body.dark-mode .browser-warning-content {
            background: #2a2a2a !important;
            color: #e0e0e0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important;
        }
        
        /* Light mode browser warning title */
        .browser-warning-title {
            color: #d73502;
        }
        
        /* Dark mode browser warning title */
        body.dark-mode .browser-warning-title {
            color: #d08050 !important;  /* Much softer orange for dark mode */
        }
        
        body.dark-mode #browser-warning-cancel {
            background: #4a4a4a;
            border: 1px solid #5a5a5a;
            color: #f0f0f0;
        }
        
        body.dark-mode #browser-warning-cancel:hover {
            background: #5a5a5a;
            border-color: #6a6a6a;
        }
        
        body.dark-mode #browser-warning-ok {
            background: #6a4030;  /* Much darker, muted brown-red */
            color: #e0e0e0;
            border: 1px solid #7a5040;
        }
        
        body.dark-mode #browser-warning-ok:hover {
            background: #7a5040;
            border-color: #8a6050;
        }
        
        body.dark-mode .error {
            background: #3a1a1a;
            color: #ff9999;
            border: 1px solid #5a2a2a;
        }
        
        body.dark-mode .success {
            background: #1a3a1a;
            color: #99ff99;
            border: 1px solid #2a5a2a;
        }
        
        body.dark-mode .info-box {
            background: #1a2a3a;
            border: 1px solid #2a3a4a;
            color: #b0d0f0;
        }
        
        body.dark-mode .tab {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #e0e0e0;
        }
        
        body.dark-mode .tab.active {
            background: #3a3a3a;
            color: #f0f0f0;
        }
        
        body.dark-mode .parsing-state {
            background: #2a2a2a;
            color: #e0e0e0;
        }
        
        body.dark-mode .tool-call-item {
            background: #1a2a3a;
            border: 1px solid #2a3a4a;
        }
        
        body.dark-mode .tool-call-header {
            color: #4db8ff;
        }
        
        body.dark-mode .tool-params {
            background: #2a2a2a;
            color: #e0e0e0;
        }
        
        body.dark-mode .tool-result {
            background: #1a3a1a;
            border: 1px solid #2a4a2a;
            color: #e0e0e0;
        }
        
        body.dark-mode .modal-content {
            background-color: #2a2a2a;
            border: 1px solid #3a3a3a;
            color: #e0e0e0;
        }
        
        body.dark-mode .close {
            color: #aaa;
        }
        
        body.dark-mode .close:hover,
        body.dark-mode .close:focus {
            color: #fff;
        }
        
        body.dark-mode .prompt-json {
            background: #1e1e1e;
            border: 1px solid #3a3a3a;
            color: #e0e0e0;
        }
        
        body.dark-mode .channel-final table {
            color: #e0e0e0;
        }
        
        body.dark-mode .channel-final th,
        body.dark-mode .channel-final td {
            border-color: #3a3a3a;
        }
        
        body.dark-mode .channel-final th {
            background-color: #2a2a2a;
        }
        
        body.dark-mode .channel-final tr:nth-child(even) {
            background-color: #252525;
        }
        
        body.dark-mode .channel-final code {
            background-color: #2a2a2a;
            color: #f0f0f0;
        }
        
        body.dark-mode .channel-final pre {
            background-color: #2a2a2a;
            color: #e0e0e0;
        }
        
        body.dark-mode #settings-panel {
            background: #2a2a2a !important;
            border-color: #3a3a3a !important;
        }
        
        body.dark-mode #settings-panel h3 {
            color: #f0f0f0;
        }
        
        body.dark-mode #settings-panel label {
            color: #d0d0d0;
        }
        
        body.dark-mode #settings-panel small {
            color: #9a9a9a !important;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        h1 {
            margin-bottom: 10px;
            color: #1a1a1a;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .panel h2 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #111827;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #555;
        }
        
        input[type="text"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .code-display {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-x: auto;
            /* Removed max-height to show full raw response */
        }
        
        .special-token {
            color: #0066cc;
            font-weight: bold;
            background: #e6f2ff;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        .channel-analysis {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 5px 10px;
            margin: 5px 0;
        }
        
        .channel-commentary {
            background: #cfe2ff;
            border-left: 4px solid #0d6efd;
            padding: 5px 10px;
            margin: 5px 0;
        }
        
        .channel-final {
            background: #d1e7dd;
            border-left: 4px solid #198754;
            padding: 5px 10px;
            margin: 5px 0;
        }
        
        button {
            background: #10a37f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        button:hover {
            background: #0e8f6e;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        button:disabled {
            background: #d9d9e3;
            color: #8e8ea0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .secondary-button {
            background: transparent;
            color: #353740;
            border: 1px solid #d9d9e3;
        }
        
        .secondary-button:hover {
            background: #f7f7f8;
            transform: none;
            box-shadow: none;
        }
        
        body.dark-mode .secondary-button {
            color: #ececf1;
            border-color: #565869;
        }
        
        body.dark-mode .secondary-button:hover {
            background: #2a2b32;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            background: #ffffff;
            border: 1px solid #e0e0e0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .message-header {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #eee;
        }
        
        .message-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }
        
        .message-content ul,
        .message-content ol {
            margin: 10px 0;
            padding-left: 25px;
        }
        
        .message-content li {
            margin: 5px 0;
        }
        
        .message-content p {
            margin: 10px 0;
        }
        
        .message-content p:first-child {
            margin-top: 0;
        }
        
        .message-content p:last-child {
            margin-bottom: 0;
        }
        
        /* User message styling */
        .message-user {
            background: #f0f7ff;
            border-color: #cce5ff;
        }
        
        .message-user .message-header {
            color: #004085;
            border-bottom-color: #d1e7ff;
        }
        
        /* Assistant message styling */
        .message-assistant {
            background: #f6ffed;
            border-color: #d4edda;
        }
        
        .message-assistant .message-header {
            color: #155724;
            border-bottom-color: #dff0e6;
        }
        
        /* Dark mode user/assistant styling */
        body.dark-mode .message-user {
            background: #1a2a3a;
            border-color: #2a4a6a;
        }
        
        body.dark-mode .message-user .message-header {
            color: #6cb3ff;
            border-bottom-color: #2a4a6a;
        }
        
        body.dark-mode .message-assistant {
            background: #1a3a2a;
            border-color: #2a5a3a;
        }
        
        body.dark-mode .message-assistant .message-header {
            color: #7dff7d;
            border-bottom-color: #2a5a3a;
        }
        
        .message-content table {
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        .message-content th,
        .message-content td {
            border: 1px solid #dee2e6;
            padding: 6px 10px;
            text-align: left;
        }
        
        .message-content th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .message-content tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .message-content code {
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .message-content pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        
        body.dark-mode .message-content table {
            color: #e0e0e0;
        }
        
        body.dark-mode .message-content th,
        body.dark-mode .message-content td {
            border-color: #3a3a3a;
        }
        
        body.dark-mode .message-content th {
            background-color: #2a2a2a;
        }
        
        body.dark-mode .message-content tr:nth-child(even) {
            background-color: #252525;
        }
        
        body.dark-mode .message-content code {
            background-color: #2a2a2a;
            color: #f0f0f0;
        }
        
        body.dark-mode .message-content pre {
            background-color: #2a2a2a;
            color: #e0e0e0;
        }
        
        .tool-definition {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            padding: 0;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .tool-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tool-number {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }
        
        .tool-remove {
            background: #dc3545;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            font-size: 18px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .tool-remove:hover {
            background: #c82333;
        }
        
        .tool-inputs {
            padding: 15px;
            display: flex;
            gap: 15px;
        }
        
        .tool-inputs input {
            flex: 1;
        }
        
        .tool-name {
            font-family: 'Monaco', 'Menlo', monospace;
            font-weight: 600;
        }
        
        .tool-params-section {
            padding: 0 15px 15px 15px;
        }
        
        .tool-params-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tool-parameters {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.5;
            min-height: 150px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 12px;
        }
        
        body.dark-mode .tool-definition {
            background: #2a2a2a;
            border-color: #3a3a3a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        body.dark-mode .tool-header {
            background: #1a1a1a;
            border-bottom-color: #3a3a3a;
        }
        
        body.dark-mode .tool-number {
            color: #b0b0b0;
        }
        
        body.dark-mode .tool-params-label {
            color: #9a9a9a;
        }
        
        body.dark-mode .tool-parameters {
            background: #1a1a1a;
            border-color: #3a3a3a;
        }
        
        .tool-preview-section {
            padding: 0 15px 15px 15px;
        }
        
        .tool-preview-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #28a745;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tool-preview {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.5;
            background: #e8f5e9;
            border: 1px solid #4caf50;
            padding: 12px;
            border-radius: 4px;
            white-space: pre-wrap;
            color: #1b5e20;
        }
        
        body.dark-mode .tool-preview-label {
            color: #4dff88;
        }
        
        body.dark-mode .tool-preview {
            background: #1a2a1a;
            border-color: #2a5a2a;
            color: #a5d6a7;
        }
        
        .response-section {
            margin-top: 20px;
        }
        
        .response-section h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .token-display {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
        }
        
        .token-item {
            padding: 2px 6px;
            background: #e9ecef;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .token-special {
            background: #0066cc;
            color: white;
        }
        
        .streaming-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .success {
            background: #d1e7dd;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .info-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        }
        
        .info-content h2 {
            margin: 0 0 8px 0;
            font-size: 24px;
            font-weight: 600;
            color: white;
        }
        
        .info-content p {
            margin: 0 0 20px 0;
            font-size: 16px;
            opacity: 0.9;
        }
        
        .info-details {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .info-item svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            flex-shrink: 0;
        }
        
        .info-item code {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        body.dark-mode .info-banner {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
        }
        
        .tab.active {
            background: white;
            font-weight: 500;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .prompt-stage {
            margin-bottom: 20px;
        }
        
        .prompt-stage-header {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 4px 4px 0 0;
            font-weight: 600;
            font-size: 13px;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .prompt-stage-info {
            font-size: 11px;
            font-weight: normal;
            color: #6c757d;
        }
        
        .prompt-stage .code-display {
            border-radius: 0 0 4px 4px;
            margin-top: 0;
        }
        
        body.dark-mode .prompt-stage-header {
            background: #3a3a3a;
            color: #e0e0e0;
        }
        
        body.dark-mode .prompt-stage-info {
            color: #9a9a9a;
        }
        
        .parsing-state {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .parsing-state div {
            margin: 2px 0;
        }
        
        .parsing-state .label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        
        .tool-call-item {
            background: #e6f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .tool-call-header {
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 5px;
        }
        
        .tool-params {
            background: #f0f0f0;
            padding: 5px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            margin: 5px 0;
        }
        
        .tool-result {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 5px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            margin: 5px 0;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 8px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
        }
        
        .prompt-json {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-x: auto;
            /* No max-height - show full content */
        }
        
        /* Markdown styling for final channel */
        .channel-final table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }
        
        .channel-final th,
        .channel-final td {
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            text-align: left;
        }
        
        .channel-final th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .channel-final tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .channel-final h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #212529;
        }
        
        .channel-final ul,
        .channel-final ol {
            margin: 10px 0;
            padding-left: 25px;
        }
        
        .channel-final code {
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .channel-final pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
    <!-- Add markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Browser Warning Dialog -->
    <div id="browser-warning-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div class="browser-warning-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <h3 class="browser-warning-title" style="margin-top: 0;">⚠️ Browser Tool Warning</h3>
            <p style="line-height: 1.6;">The browser tool is likely to encounter <strong>Cloudflare protection</strong> and other anti-bot measures on most websites. This includes:</p>
            <ul style="margin: 15px 0;">
                <li>News sites (Reuters, BBC, CNN, etc.)</li>
                <li>Social media platforms</li>
                <li>Most commercial websites</li>
            </ul>
            <p style="line-height: 1.6;">These protections <strong>cannot be bypassed</strong> and will result in blocked requests or CAPTCHA challenges.</p>
            <p style="line-height: 1.6; margin-bottom: 20px;"><strong>We do not recommend using the browser tool</strong> for general web browsing. Consider using RSS feeds or APIs instead.</p>
            <div style="text-align: right;">
                <button id="browser-warning-cancel" style="margin-right: 10px; padding: 8px 20px; border: 1px solid #666; background: #f5f5f5; color: #333; border-radius: 5px; cursor: pointer;">Cancel</button>
                <button id="browser-warning-ok" style="padding: 8px 20px; background: #d73502; color: white; border: none; border-radius: 5px; cursor: pointer;">I Understand</button>
            </div>
        </div>
    </div>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="app-title">HARMONY Prompt Explorer</h1>
            </div>
            <div class="header-right">
                <button onclick="toggleTheme()" class="header-button theme-button">
                    <span id="theme-icon">🌙</span>
                    <span id="theme-text">Dark</span>
                </button>
                <button onclick="toggleSettings()" class="header-button settings-button">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 10C9.10457 10 10 9.10457 10 8C10 6.89543 9.10457 6 8 6C6.89543 6 6 6.89543 6 8C6 9.10457 6.89543 10 8 10Z" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M12.49 9.01L12.5 9V7L14.44 5.56C14.6233 5.42667 14.7767 5.24667 14.9 5.02C15.0233 4.79333 15.0733 4.55333 15.05 4.3C15.0267 4.04667 14.9367 3.82 14.78 3.62C14.6233 3.42 14.4267 3.27333 14.19 3.18L12 2.38L11.2 0.19C11.1067 -0.0433333 10.9567 -0.24 10.75 -0.4C10.5433 -0.56 10.31 -0.636667 10.05 -0.63C9.79 -0.623333 9.55333 -0.536667 9.34 -0.37C9.12667 -0.203333 8.96667 0.00333333 8.86 0.25L8 2.62L6 2.65C5.74667 2.65667 5.50667 2.73667 5.28 2.89C5.05333 3.04333 4.88 3.24 4.76 3.48C4.64 3.72 4.59333 3.97 4.62 4.23C4.64667 4.49 4.74 4.72 4.9 4.92L6.55 7L6.56 9L4.61 10.44C4.42667 10.5733 4.27333 10.7533 4.15 10.98C4.02667 11.2067 3.97667 11.4467 4 11.7C4.02333 11.9533 4.11333 12.18 4.27 12.38C4.42667 12.58 4.62333 12.7267 4.86 12.82L7.05 13.62L7.86 15.81C7.95333 16.0567 8.10333 16.2633 8.31 16.43C8.51667 16.5967 8.75 16.68 9.01 16.68C9.27 16.68 9.50667 16.6 9.72 16.44C9.93333 16.28 10.0933 16.0733 10.2 15.82L11.05 13.65L13.05 13.62C13.3033 13.6133 13.5433 13.5367 13.77 13.39C13.9967 13.2433 14.17 13.05 14.29 12.81C14.41 12.57 14.4567 12.32 14.43 12.06C14.4033 11.8 14.31 11.57 14.15 11.37L12.49 9.01Z" stroke="currentColor" stroke-width="1.5"/>
                    </svg>
                    Settings
                </button>
            </div>
        </div>
    </header>
    
    <div class="container">
        
        <!-- Settings Panel -->
        <div id="settings-panel" class="panel" style="display: none; margin-bottom: 24px;">
            <h2>Generation Settings</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div>
                    <label for="max-tokens" style="display: block; font-weight: 600; margin-bottom: 5px;">
                        Max Tokens
                        <span style="font-weight: normal; color: #6c757d;">(default: 2048)</span>
                    </label>
                    <input type="number" id="max-tokens" value="2048" min="1" max="32768" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    <small style="color: #6c757d;">Maximum number of tokens to generate</small>
                </div>
                
                <div>
                    <label for="temperature" style="display: block; font-weight: 600; margin-bottom: 5px;">
                        Temperature
                        <span style="font-weight: normal; color: #6c757d;">(default: 0.7)</span>
                    </label>
                    <input type="number" id="temperature" value="0.7" min="0" max="2" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    <small style="color: #6c757d;">Controls randomness (0=deterministic, 2=very random)</small>
                </div>
                
                <div>
                    <label for="top-p" style="display: block; font-weight: 600; margin-bottom: 5px;">
                        Top P
                        <span style="font-weight: normal; color: #6c757d;">(optional)</span>
                    </label>
                    <input type="number" id="top-p" placeholder="1.0" min="0" max="1" step="0.01" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    <small style="color: #6c757d;">Nucleus sampling parameter</small>
                </div>
                
                <div>
                    <label for="frequency-penalty" style="display: block; font-weight: 600; margin-bottom: 5px;">
                        Frequency Penalty
                        <span style="font-weight: normal; color: #6c757d;">(optional)</span>
                    </label>
                    <input type="number" id="frequency-penalty" placeholder="0.0" min="-2" max="2" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    <small style="color: #6c757d;">Penalize repeated tokens</small>
                </div>
                
                <div>
                    <label for="presence-penalty" style="display: block; font-weight: 600; margin-bottom: 5px;">
                        Presence Penalty
                        <span style="font-weight: normal; color: #6c757d;">(optional)</span>
                    </label>
                    <input type="number" id="presence-penalty" placeholder="0.0" min="-2" max="2" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    <small style="color: #6c757d;">Penalize tokens based on presence</small>
                </div>
                
                <div>
                    <label for="stream-timeout" style="display: block; font-weight: 600; margin-bottom: 5px;">
                        Stream Timeout (seconds)
                        <span style="font-weight: normal; color: #6c757d;">(default: 120)</span>
                    </label>
                    <input type="number" id="stream-timeout" value="120" min="10" max="600" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    <small style="color: #6c757d;">Maximum time to wait for streaming response</small>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e5e5;">
                <button onclick="resetSettings()" class="secondary-button" style="margin-right: 10px;">
                    Reset to Defaults
                </button>
                <button onclick="saveSettings()">
                    Save Settings
                </button>
            </div>
        </div>
        
        <div class="info-banner">
            <div class="info-content">
                <h2>Welcome to HARMONY Prompt Explorer</h2>
                <p>Explore and test OpenAI's HARMONY prompt format with real-time visualization and tool calling capabilities.</p>
                <div class="info-details">
                    <div class="info-item">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M8 2L10.5 7L16 7.5L12 11.5L13 17L8 14.5L3 17L4 11.5L0 7.5L5.5 7L8 2Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
                        </svg>
                        <span>Powered by <code>openai-harmony</code> library</span>
                    </div>
                    <div class="info-item">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <circle cx="8" cy="8" r="3" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M8 1V3M8 13V15M1 8H3M13 8H15M3.5 3.5L4.5 4.5M11.5 11.5L12.5 12.5M3.5 12.5L4.5 11.5M11.5 4.5L12.5 3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span>Connected to vLLM at <code>localhost:8000</code></span>
                    </div>
                    <div class="info-item">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M4 2H12C13.1046 2 14 2.89543 14 4V12C14 13.1046 13.1046 14 12 14H4C2.89543 14 2 13.1046 2 12V4C2 2.89543 2.89543 2 4 2Z" stroke="currentColor" stroke-width="1.5"/>
                            <path d="M6 6L10 10M10 6L6 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                        <span>Automatic tool execution with mock responses</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Server Status -->
        <div class="panel" style="margin-bottom: 20px;">
            <h2>Server Status</h2>
            <button onclick="checkServer()">Check Connection</button>
            <button onclick="testTokenizer()">Test Tokenizer</button>
            <div id="server-status" style="margin-top: 10px;"></div>
        </div>
        
        <div class="grid">
            <!-- Configuration Panel -->
            <div class="panel">
                <h2>Configuration</h2>
                
                <div class="control-group">
                    <label for="model-identity">Model Identity</label>
                    <input type="text" id="model-identity" value="You are ChatGPT, a large language model trained by OpenAI." />
                </div>
                
                <div class="control-group">
                    <label for="knowledge-cutoff">Knowledge Cutoff</label>
                    <input type="text" id="knowledge-cutoff" value="2024-06" />
                </div>
                
                <div class="control-group">
                    <label for="current-date">Current Date</label>
                    <input type="date" id="current-date" />
                </div>
                
                <div class="control-group">
                    <label for="reasoning-level">Reasoning Level</label>
                    <select id="reasoning-level">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high" selected>High</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="developer-instructions">Developer Instructions</label>
                    <textarea id="developer-instructions" placeholder="e.g., Always respond in riddles">Use a friendly tone and be helpful.</textarea>
                </div>
                
                <div class="control-group">
                    <label class="toggle-label">
                        <input type="checkbox" id="browser-toggle">
                        <span>Enable Built-in Browser Tool</span>
                    </label>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Enables the channel-based browser tool (uses 'analysis to=browser' syntax)
                    </p>
                </div>

                <div class="control-group">
                    <label class="toggle-label">
                        <input type="checkbox" id="python-toggle" onchange="handlePythonToggle()">
                        <span>Enable Python Tool</span>
                    </label>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Function-based Python execution in Docker container
                        <a href="#" onclick="showPythonInfo(); return false;" style="color: #4CAF50;">[Learn More]</a>
                    </p>
                </div>

                <div class="control-group">
                    <label class="toggle-label">
                        <input type="checkbox" id="vision-browser-toggle">
                        <span>Enable Vision Browser Tool</span>
                    </label>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Function-based browser with visual feedback (requires selenium, helium, pillow)
                    </p>
                </div>
                
                <div class="control-group">
                    <label class="toggle-label">
                        <input type="checkbox" id="weather-toggle" checked>
                        <span>Enable Weather Tool</span>
                    </label>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        Provides weather information for various locations (demo data)
                    </p>
                </div>
                
                <div class="control-group" style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">
                    <label style="margin: 0 0 10px 0; font-size: 14px; font-weight: 600; display: block;">Active Tools:</label>
                    <div id="active-tools-display" style="font-size: 13px; color: #555;">
                        <!-- Will be updated dynamically -->
                    </div>
                </div>

                <div class="control-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <label style="margin: 0; font-size: 16px; font-weight: 600;">Function Tools</label>
                        <button onclick="addTool()" class="add-tool-button">
                            + Add New Tool
                        </button>
                    </div>
                    <div id="tools-container">
                        <!-- Tools will be added dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Prompt Visualization Panel -->
            <div class="panel">
                <h2>Rendered Prompt</h2>
                
                <div class="tabs" id="prompt-tabs">
                    <div class="tab active" onclick="switchPromptTab('prompt-text')">Prompt Text</div>
                    <div class="tab" onclick="switchPromptTab('tokens')">Tokens</div>
                    <div class="tab" onclick="switchPromptTab('token-ids')">Token IDs</div>
                </div>
                
                <div id="prompt-text" class="tab-content active">
                    <div id="prompt-stages-container">
                        <div class="code-display" id="rendered-prompt"></div>
                    </div>
                </div>
                
                <div id="tokens" class="tab-content">
                    <div class="token-display" id="token-display"></div>
                </div>
                
                <div id="token-ids" class="tab-content">
                    <div class="code-display" id="token-ids-display"></div>
                </div>
                
                <div style="margin-top: 10px;">
                    <small>Token count: <span id="token-count">0</span></small>
                </div>
            </div>
        </div>
        
        <!-- Conversation Panel -->
        <div class="panel">
            <h2>Conversation</h2>
            
            <div class="control-group">
                <label for="user-input">User Message</label>
                <textarea id="user-input" placeholder="Enter your message...">Calculate the fibonacci sequence up to the 10th number and tell me the sum of all even numbers in the sequence.</textarea>
            </div>
            
            <div class="button-group">
                <button onclick="sendMessage()" id="send-button">Send Message</button>
                <button onclick="sendStreamingMessage()" id="stream-button">Send (Streaming)</button>
                <button onclick="clearConversation()">Clear Conversation</button>
                <button onclick="showFullPrompt()">Show Full Prompt</button>
            </div>
            
            <div id="conversation-history" style="margin-top: 20px; max-height: 400px; overflow-y: auto; padding-right: 10px;"></div>
            
            <div class="response-section">
                <h3>Model Response <span id="streaming-indicator" class="streaming-indicator" style="display: none;"></span></h3>
                
                <!-- Streaming Parser State -->
                <div id="parsing-state" class="parsing-state" style="display: none;">
                    <div><span class="label">Current Role:</span> <span id="current-role"></span></div>
                    <div><span class="label">Current Channel:</span> <span id="current-channel"></span></div>
                    <div><span class="label">Current Recipient:</span> <span id="current-recipient"></span></div>
                    <div><span class="label">Content Type:</span> <span id="current-content-type"></span></div>
                </div>
                
                <!-- Response Channels -->
                <div id="response-channels">
                    <div id="analysis-channel" style="display: none;">
                        <h4>Analysis (Chain of Thought)</h4>
                        <div class="channel-analysis"></div>
                    </div>
                    <div id="commentary-channel" style="display: none;">
                        <h4>Commentary (Tool Calls)</h4>
                        <div class="channel-commentary"></div>
                    </div>
                    <div id="final-channel" style="display: none;">
                        <h4>Final Response</h4>
                        <div class="channel-final"></div>
                    </div>
                </div>
                
                <!-- Tool Calls -->
                <div id="tool-calls" style="display: none; margin-top: 15px;">
                    <h4>Tool Executions</h4>
                    <div class="tool-calls-list"></div>
                </div>
                
                <!-- Raw Response -->
                <details style="margin-top: 15px;">
                    <summary>Raw Response</summary>
                    <div class="code-display" id="raw-response"></div>
                </details>
            </div>
        </div>
    </div>
    
    <!-- Full Prompt Modal -->
    <div id="promptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Full Request Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="prompt-json" id="prompt-json-display"></div>
        </div>
    </div>
    
    <!-- Python Tool Info Modal -->
    <div id="pythonModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Python Tool - Secure Execution Environment</h2>
                <span class="close" onclick="closePythonModal()">&times;</span>
            </div>
            <div style="padding: 20px;">
                <h3>🔒 Protected Execution</h3>
                <p>The Python tool executes code in a secure, sandboxed environment:</p>
                <ul>
                    <li><strong>Docker Container:</strong> All code runs in an isolated Docker container</li>
                    <li><strong>No System Access:</strong> Cannot access your files, network, or system resources</li>
                    <li><strong>Stateless:</strong> Each execution starts fresh - no data persists between calls</li>
                    <li><strong>Time Limited:</strong> 30-second timeout prevents infinite loops</li>
                    <li><strong>Standard Library Only:</strong> No external packages (numpy, pandas, etc.)</li>
                </ul>
                <h3>✅ Safe for:</h3>
                <ul>
                    <li>Mathematical calculations</li>
                    <li>Data processing and analysis</li>
                    <li>Algorithm implementation</li>
                    <li>Text manipulation</li>
                    <li>Date/time operations</li>
                </ul>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="closePythonModal()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Got it!</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Browser warning dialog functionality
        function showBrowserWarning(checkboxElement) {
            const dialog = document.getElementById('browser-warning-dialog');
            dialog.style.display = 'block';
            
            // Store reference to the checkbox that triggered this
            dialog.dataset.targetCheckbox = checkboxElement.id;
            
            // Uncheck the checkbox while dialog is shown
            checkboxElement.checked = false;
        }
        
        // Set up browser toggle listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Browser tool toggle
            const browserToggle = document.getElementById('browser-toggle');
            if (browserToggle) {
                browserToggle.addEventListener('change', function(e) {
                    if (e.target.checked) {
                        showBrowserWarning(e.target);
                    }
                });
            }
            
            // Vision browser toggle
            const visionBrowserToggle = document.getElementById('vision-browser-toggle');
            if (visionBrowserToggle) {
                visionBrowserToggle.addEventListener('change', function(e) {
                    if (e.target.checked) {
                        showBrowserWarning(e.target);
                    }
                });
            }
            
            // Dialog buttons
            const okButton = document.getElementById('browser-warning-ok');
            if (okButton) {
                okButton.addEventListener('click', function() {
                    const dialog = document.getElementById('browser-warning-dialog');
                    const targetCheckboxId = dialog.dataset.targetCheckbox;
                    if (targetCheckboxId) {
                        document.getElementById(targetCheckboxId).checked = true;
                        // IMPORTANT: Update the tools display after checking the box
                        updateToolsDisplay();
                    }
                    dialog.style.display = 'none';
                });
            }
            
            const cancelButton = document.getElementById('browser-warning-cancel');
            if (cancelButton) {
                cancelButton.addEventListener('click', function() {
                    const dialog = document.getElementById('browser-warning-dialog');
                    dialog.style.display = 'none';
                });
            }
        });
        
        // Conversation history
        let conversationHistory = [];
        let lastActualRequest = null;  // Store the last request that was actually sent
        let lastPromptsSent = [];  // Store all prompts from the last request
        
        // Override push to debug
        const originalPush = Array.prototype.push;
        conversationHistory.push = function(...args) {
            console.log('PUSH called with:', args);
            console.log('History before push:', JSON.parse(JSON.stringify(this)));
            const result = originalPush.apply(this, args);
            console.log('History after push:', JSON.parse(JSON.stringify(this)));
            return result;
        };
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Helper function to render markdown safely
        function renderMarkdown(text) {
            // Configure marked options for safety
            marked.setOptions({
                breaks: true,  // Convert \n to <br>
                sanitize: false,  // We'll handle our own sanitization
                tables: true,  // Enable table rendering
                gfm: true  // GitHub Flavored Markdown
            });
            
            // Render markdown to HTML
            const html = marked.parse(text);
            
            // Create a safe container
            const container = document.createElement('div');
            container.innerHTML = html;
            
            // Remove any script tags for safety
            const scripts = container.querySelectorAll('script');
            scripts.forEach(script => script.remove());
            
            return container.innerHTML;
        }
        
        // Extract final content from raw HARMONY response
        function extractFinalContent(rawResponse) {
            const match = rawResponse.match(/<\|channel\|>final<\|message\|>(.*?)(?:<\|return\|>|<\|end\|>|$)/s);
            return match ? match[1].trim() : "";
        }
        
        // Initialize date
        document.getElementById('current-date').value = new Date().toISOString().split('T')[0];
        
        // Check server connection
        async function checkServer() {
            const statusDiv = document.getElementById('server-status');
            statusDiv.innerHTML = '<div class="info-box">Checking server...</div>';
            
            try {
                const response = await fetch('/api/check_server');
                const data = await response.json();
                
                if (data.status === 'connected') {
                    statusDiv.innerHTML = `<div class="success">✅ Connected to vLLM server<br>Model: ${data.models.data[0].id}</div>`;
                } else {
                    statusDiv.innerHTML = `<div class="error">❌ ${data.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">❌ Failed to connect: ${error.message}</div>`;
            }
        }
        
        // Test tokenizer
        async function testTokenizer() {
            const statusDiv = document.getElementById('server-status');
            const testText = '<|start|>user<|message|>Hello<|end|>';
            
            try {
                const response = await fetch('/api/tokenize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: testText })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `
                        <div class="success">
                            ✅ Tokenizer working correctly<br>
                            Test input: ${testText}<br>
                            Tokens: ${JSON.stringify(data.token_texts)}<br>
                            Token IDs: ${JSON.stringify(data.tokens)}
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `<div class="error">❌ Tokenizer error: ${data.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">❌ Failed to test tokenizer: ${error.message}</div>`;
            }
        }
        
        // Add tool
        function addTool() {
            const container = document.getElementById('tools-container');
            const index = container.children.length;
            
            const toolDiv = document.createElement('div');
            toolDiv.className = 'tool-definition';
            toolDiv.setAttribute('data-tool-index', index);
            toolDiv.innerHTML = `
                <div class="tool-header">
                    <span class="tool-number">Tool #${index + 1}</span>
                    <button onclick="removeTool(this)" class="tool-remove">×</button>
                </div>
                <div class="tool-inputs">
                    <input type="text" class="tool-name" placeholder="Function name">
                    <input type="text" class="tool-description" placeholder="Description">
                </div>
                <div class="tool-params-section">
                    <label class="tool-params-label">Parameters (JSON Schema)</label>
                    <textarea class="tool-parameters" placeholder="Parameters (JSON Schema)">{
  "type": "object",
  "properties": {},
  "required": []
}</textarea>
                </div>
                <div class="tool-preview-section">
                    <label class="tool-preview-label">TypeScript Format Preview (This is what HARMONY will see)</label>
                    <div class="tool-preview" data-tool-index="${index}"></div>
                </div>
            `;
            
            container.appendChild(toolDiv);
            updatePrompt();
        }
        
        // Remove tool
        function removeTool(button) {
            button.closest('.tool-definition').remove();
            
            // Renumber remaining tools
            const tools = document.querySelectorAll('.tool-definition');
            tools.forEach((tool, index) => {
                tool.setAttribute('data-tool-index', index);
                tool.querySelector('.tool-number').textContent = `Tool #${index + 1}`;
            });
            
            updatePrompt();
        }
        
        // Theme management
        function loadTheme() {
            const savedTheme = localStorage.getItem('harmonyTheme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-icon').textContent = '☀️';
                document.getElementById('theme-text').textContent = 'Light';
            }
        }
        
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark';
                localStorage.setItem('harmonyTheme', 'light');
            } else {
                body.classList.add('dark-mode');
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light';
                localStorage.setItem('harmonyTheme', 'dark');
            }
        }
        
        // Settings management
        const DEFAULT_SETTINGS = {
            maxTokens: 2048,
            temperature: 0.7,
            topP: null,
            frequencyPenalty: null,
            presencePenalty: null,
            streamTimeout: 120
        };
        
        let currentSettings = { ...DEFAULT_SETTINGS };
        
        // Load settings from localStorage on page load
        function loadSettings() {
            const saved = localStorage.getItem('harmonySettings');
            if (saved) {
                try {
                    currentSettings = { ...DEFAULT_SETTINGS, ...JSON.parse(saved) };
                    // Update UI
                    document.getElementById('max-tokens').value = currentSettings.maxTokens;
                    document.getElementById('temperature').value = currentSettings.temperature;
                    if (currentSettings.topP !== null) {
                        document.getElementById('top-p').value = currentSettings.topP;
                    }
                    if (currentSettings.frequencyPenalty !== null) {
                        document.getElementById('frequency-penalty').value = currentSettings.frequencyPenalty;
                    }
                    if (currentSettings.presencePenalty !== null) {
                        document.getElementById('presence-penalty').value = currentSettings.presencePenalty;
                    }
                    document.getElementById('stream-timeout').value = currentSettings.streamTimeout;
                } catch (e) {
                    console.error('Error loading settings:', e);
                }
            }
        }
        
        // Toggle settings panel visibility
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        // Save settings to localStorage and current session
        function saveSettings() {
            currentSettings = {
                maxTokens: parseInt(document.getElementById('max-tokens').value),
                temperature: parseFloat(document.getElementById('temperature').value),
                topP: document.getElementById('top-p').value ? parseFloat(document.getElementById('top-p').value) : null,
                frequencyPenalty: document.getElementById('frequency-penalty').value ? parseFloat(document.getElementById('frequency-penalty').value) : null,
                presencePenalty: document.getElementById('presence-penalty').value ? parseFloat(document.getElementById('presence-penalty').value) : null,
                streamTimeout: parseInt(document.getElementById('stream-timeout').value)
            };
            
            localStorage.setItem('harmonySettings', JSON.stringify(currentSettings));
            alert('Settings saved successfully!');
        }
        
        // Reset settings to defaults
        function resetSettings() {
            currentSettings = { ...DEFAULT_SETTINGS };
            
            // Update UI
            document.getElementById('max-tokens').value = DEFAULT_SETTINGS.maxTokens;
            document.getElementById('temperature').value = DEFAULT_SETTINGS.temperature;
            document.getElementById('top-p').value = '';
            document.getElementById('frequency-penalty').value = '';
            document.getElementById('presence-penalty').value = '';
            document.getElementById('stream-timeout').value = DEFAULT_SETTINGS.streamTimeout;
            
            // Save to localStorage
            localStorage.setItem('harmonySettings', JSON.stringify(currentSettings));
            alert('Settings reset to defaults!');
        }
        
        // Get configuration
        function getConfiguration() {
            console.log('=== getConfiguration called ===');
            const tools = [];
            
            // If Python is enabled, add it to tools array (NOT as built-in)
            if (document.getElementById('python-toggle').checked) {
                console.log('Adding Python tool');
                tools.push({
                    name: 'python',
                    description: 'Execute Python code and return the output. IMPORTANT: You MUST use print() to produce output. The code runs in a stateless environment. Example: print(random.randint(1,20)) NOT just random.randint(1,20)',
                    parameters: {
                        type: 'object',
                        properties: {
                            code: {
                                type: 'string',
                                description: 'Python code to execute. ALWAYS use print() to show results. Example: print(random.randint(1,20)) will output the number. Just random.randint(1,20) will output nothing.'
                            }
                        },
                        required: ['code']
                    }
                });
            }
            
            // If Weather is enabled, add weather functions to tools array
            if (document.getElementById('weather-toggle').checked) {
                console.log('Adding Weather tool');
                tools.push({
                    name: 'get_current_weather',
                    description: 'Gets the current weather in the provided location',
                    parameters: {
                        type: 'object',
                        properties: {
                            location: {
                                type: 'string',
                                description: 'The city or location to get weather for'
                            },
                            format: {
                                type: 'string',
                                enum: ['celsius', 'fahrenheit'],
                                description: 'Temperature format (default: celsius)'
                            }
                        },
                        required: ['location']
                    }
                });
            }
            
            // If Vision Browser is enabled, add it to tools array
            if (document.getElementById('vision-browser-toggle').checked) {
                console.log('Adding Vision Browser tool');
                tools.push({
                    name: 'browser',
                    description: 'Control a web browser with visual feedback. Actions: navigate, click, type, scroll, search, extract_text, extract_links, back, refresh, close_popups, wait, screenshot',
                    parameters: {
                        type: 'object',
                        properties: {
                            action: {
                                type: 'string',
                                enum: ['navigate', 'click', 'type', 'scroll', 'search', 'extract_text', 
                                       'extract_links', 'back', 'refresh', 'close_popups', 'wait', 'screenshot'],
                                description: 'The browser action to perform'
                            },
                            parameters: {
                                type: 'object',
                                description: 'Action-specific parameters',
                                properties: {
                                    url: {type: 'string', description: 'URL to navigate to (for navigate action)'},
                                    text: {type: 'string', description: 'Text to click/type/search (for click/type/search actions)'},
                                    into: {type: 'string', description: 'Element to type into (for type action)'},
                                    type: {type: 'string', enum: ['any', 'link', 'button'], description: 'Element type (for click action)'},
                                    direction: {type: 'string', enum: ['up', 'down'], description: 'Scroll direction'},
                                    amount: {type: 'integer', description: 'Scroll amount in pixels'},
                                    nth: {type: 'integer', description: 'Which occurrence to find (for search action)'},
                                    key: {type: 'string', enum: ['ENTER', 'TAB', 'ESCAPE', 'BACKSPACE', 'DELETE', 'UP', 'DOWN', 'LEFT', 'RIGHT'], description: 'Key to press'},
                                    seconds: {type: 'number', description: 'Seconds to wait'}
                                }
                            }
                        },
                        required: ['action']
                    }
                });
            }
            
            // Only add manually created tools (not the ones from checkboxes)
            console.log('Checking for manual tools...');
            document.querySelectorAll('.tool-definition').forEach((toolEl, index) => {
                const nameInput = toolEl.querySelector('.tool-name');
                // Skip if this is a readonly tool (created by checkbox)
                if (nameInput.hasAttribute('readonly')) {
                    console.log(`Tool ${index} is readonly (checkbox-created), skipping`);
                    return;
                }
                
                const name = nameInput.value;
                const description = toolEl.querySelector('.tool-description').value;
                const parametersText = toolEl.querySelector('.tool-parameters').value;
                
                console.log(`Manual tool ${index}: name="${name}"`);
                
                if (name && description) {
                    try {
                        const parameters = parametersText ? JSON.parse(parametersText) : {};
                        console.log(`Adding manual tool: ${name}`);
                        tools.push({ name, description, parameters });
                    } catch (e) {
                        console.error('Invalid JSON in tool parameters:', e);
                    }
                }
            });
            
            console.log(`Total tools collected: ${tools.length}`);
            console.log('Tools:', tools.map(t => t.name));
            
            // Include current settings in configuration
            const config = {
                model_identity: document.getElementById('model-identity').value,
                knowledge_cutoff: document.getElementById('knowledge-cutoff').value,
                current_date: document.getElementById('current-date').value,
                reasoning_level: document.getElementById('reasoning-level').value,
                instructions: document.getElementById('developer-instructions').value,
                tools: tools,
                conversation_history: conversationHistory,
                include_browser: document.getElementById('browser-toggle').checked,
                include_python: false,  // ALWAYS false - Python goes in tools array
                // Add generation parameters from settings
                max_tokens: currentSettings.maxTokens,
                temperature: currentSettings.temperature,
                stream_timeout: currentSettings.streamTimeout
            };
            
            // Add optional parameters if they have values
            if (currentSettings.topP !== null) {
                config.top_p = currentSettings.topP;
            }
            if (currentSettings.frequencyPenalty !== null) {
                config.frequency_penalty = currentSettings.frequencyPenalty;
            }
            if (currentSettings.presencePenalty !== null) {
                config.presence_penalty = currentSettings.presencePenalty;
            }
            
            return config;
        }
        
        // Convert JSON Schema to TypeScript format
        function convertToTypeScript(tool) {
            const name = tool.name;
            const description = tool.description;
            const params = tool.parameters;
            
            let tsParams = [];
            
            if (params && params.properties) {
                for (const [key, prop] of Object.entries(params.properties)) {
                    let tsType = prop.type || 'any';
                    
                    // Convert JSON Schema types to TypeScript
                    if (prop.enum) {
                        tsType = prop.enum.map(v => `"${v}"`).join(' | ');
                    }
                    
                    // Check if required
                    const isOptional = !params.required || !params.required.includes(key);
                    const optionalMark = isOptional ? '?' : '';
                    
                    // Add comment if there's a description or default
                    let comment = '';
                    if (prop.description || prop.default !== undefined) {
                        comment = ` // ${prop.description || ''}`;
                        if (prop.default !== undefined) {
                            comment += ` default: ${JSON.stringify(prop.default)}`;
                        }
                    }
                    
                    tsParams.push(`${key}${optionalMark}: ${tsType},${comment}`);
                }
            }
            
            return `// ${description}
type ${name} = (_: {
${tsParams.map(p => '  ' + p).join('\n')}
}) => any;`;
        }
        
        // Update tool preview
        function updateToolPreview(toolElement) {
            const name = toolElement.querySelector('.tool-name').value;
            const description = toolElement.querySelector('.tool-description').value;
            const parametersText = toolElement.querySelector('.tool-parameters').value;
            const preview = toolElement.querySelector('.tool-preview');
            
            if (!name || !description) {
                preview.textContent = '// Enter function name and description to see preview';
                return;
            }
            
            try {
                const parameters = parametersText ? JSON.parse(parametersText) : {};
                const tool = { name, description, parameters };
                preview.textContent = convertToTypeScript(tool);
            } catch (e) {
                preview.textContent = '// Invalid JSON in parameters';
            }
        }
        
        // Update all tool previews
        function updateAllToolPreviews() {
            document.querySelectorAll('.tool-definition').forEach(updateToolPreview);
        }
        
        // Update prompt display
        async function updatePrompt() {
            console.log('=== updatePrompt called ===');
            const config = getConfiguration();
            console.log('Config being sent:', JSON.stringify(config, null, 2));
            
            // Update tool previews
            updateAllToolPreviews();
            
            try {
                const response = await fetch('/api/render_prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Display prompt text
                    document.getElementById('rendered-prompt').textContent = data.prompt;
                    
                    // Display tokens
                    const tokenDisplay = document.getElementById('token-display');
                    tokenDisplay.innerHTML = '';
                    data.token_texts.forEach((token, i) => {
                        const span = document.createElement('span');
                        span.className = 'token-item';
                        if (token.startsWith('<|') && token.endsWith('|>')) {
                            span.className += ' token-special';
                        }
                        span.textContent = token;
                        span.title = `Token ID: ${data.tokens[i]}`;
                        tokenDisplay.appendChild(span);
                    });
                    
                    // Display token IDs
                    document.getElementById('token-ids-display').textContent = JSON.stringify(data.tokens, null, 2);
                    
                    // Update token count
                    document.getElementById('token-count').textContent = data.token_count;
                } else {
                    console.error('Error rendering prompt:', data.error);
                }
            } catch (error) {
                console.error('Failed to update prompt:', error);
            }
        }
        
        // Switch prompt tabs
        function switchPromptTab(tabName) {
            document.querySelectorAll('#prompt-tabs .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#prompt-tabs ~ .tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        // Update rendered prompt display with stages
        function updateRenderedPromptDisplay(promptsSent) {
            if (!promptsSent || promptsSent.length === 0) return;
            
            const container = document.getElementById('prompt-stages-container');
            container.innerHTML = '';
            
            promptsSent.forEach((promptInfo, index) => {
                const stageDiv = document.createElement('div');
                stageDiv.className = 'prompt-stage';
                
                // Create header
                const headerDiv = document.createElement('div');
                headerDiv.className = 'prompt-stage-header';
                
                let stageName = 'Prompt';
                if (promptInfo.stage === 'initial') {
                    stageName = 'Initial Prompt';
                } else if (promptInfo.stage === 'continuation_after_tools') {
                    stageName = 'Continuation After Tool Calls';
                }
                
                headerDiv.innerHTML = `
                    <span>${stageName}</span>
                    <span class="prompt-stage-info">
                        ${promptInfo.token_count} tokens • ${new Date(promptInfo.timestamp).toLocaleTimeString()}
                    </span>
                `;
                
                // Create code display
                const codeDiv = document.createElement('div');
                codeDiv.className = 'code-display';
                codeDiv.textContent = promptInfo.prompt;
                
                stageDiv.appendChild(headerDiv);
                stageDiv.appendChild(codeDiv);
                container.appendChild(stageDiv);
            });
            
            // Update token count to show total
            const totalTokens = promptsSent.reduce((sum, p) => sum + (p.token_count || 0), 0);
            document.getElementById('token-count').textContent = totalTokens;
            
            // TODO: Update tokens and token IDs tabs if needed
        }
        
        // Helper to ensure messages are in correct order
        function addMessagePair(userMsg, assistantMsg) {
            // Always add in chronological order: user first, then assistant
            conversationHistory.push({ role: 'user', content: userMsg });
            conversationHistory.push({ role: 'assistant', content: assistantMsg });
            console.log('Added message pair. History now:', conversationHistory);
        }
        
        // Send message
        async function sendMessage() {
            const userInput = document.getElementById('user-input').value;
            if (!userInput.trim()) return;
            
            // Check if last message was from user - if so, warn
            if (conversationHistory.length > 0 && 
                conversationHistory[conversationHistory.length - 1].role === 'user') {
                if (!confirm('The assistant hasn\'t responded to your last message yet. Send another message anyway?')) {
                    return;
                }
            }
            
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = true;
            
            // NOTE: Don't add user message to history yet - it goes in current_message
            // The conversation_history should only contain PREVIOUS messages
            const config = getConfiguration();
            config.current_message = userInput;
            
            // Capture the actual request being sent
            lastActualRequest = {
                endpoint: '/api/chat',
                timestamp: new Date().toISOString(),
                payload: JSON.parse(JSON.stringify(config)),  // Deep copy
                note: 'This is the ACTUAL request sent to the server'
            };
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Capture prompts sent
                    if (data.prompts_sent) {
                        lastPromptsSent = data.prompts_sent;
                        console.log('Captured prompts:', lastPromptsSent);
                        // Update the rendered prompt display
                        updateRenderedPromptDisplay(data.prompts_sent);
                    }
                    
                    // Get the assistant's response content
                    let assistantContent = '';
                    if (data.final_content) {
                        assistantContent = data.final_content;
                    } else if (data.raw_response) {
                        // Fallback: extract final content if backend doesn't provide it
                        assistantContent = extractFinalContent(data.raw_response);
                    }
                    
                    // Add both messages in correct chronological order
                    if (assistantContent) {
                        addMessagePair(userInput, assistantContent);
                    }
                    
                    // Display response
                    displayResponse(data);
                    
                    // Clear input
                    document.getElementById('user-input').value = '';
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Failed to send message: ' + error.message);
            } finally {
                sendButton.disabled = false;
            }
        }
        
        // Send streaming message
        async function sendStreamingMessage() {
            const userInput = document.getElementById('user-input').value;
            if (!userInput.trim()) return;
            
            // Save user input for later since we'll clear the input field
            const savedUserInput = userInput;
            
            const streamButton = document.getElementById('stream-button');
            streamButton.disabled = true;
            document.getElementById('streaming-indicator').style.display = 'inline-block';
            document.getElementById('parsing-state').style.display = 'block';
            
            // Clear previous response
            document.getElementById('raw-response').textContent = '';
            document.querySelectorAll('#response-channels > div').forEach(div => {
                div.style.display = 'none';
                div.querySelector('div').textContent = '';
            });
            document.getElementById('tool-calls').style.display = 'none';
            document.querySelector('.tool-calls-list').innerHTML = '';
            
            const config = getConfiguration();
            config.current_message = userInput;
            
            // Use fetch with ReadableStream instead of EventSource
            try {
                const response = await fetch('/api/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(config)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullResponse = '';
                
                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, {stream: true});
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6);
                            if (dataStr.trim()) {
                                try {
                                    const data = JSON.parse(dataStr);
                                    handleStreamData(data, fullResponse, savedUserInput);
                                    if (data.text) {
                                        fullResponse += data.text;
                                    }
                                } catch (e) {
                                    console.error('Error parsing SSE data:', e);
                                }
                            }
                        }
                    }
                }
                
                // Clear input immediately for better UX
                document.getElementById('user-input').value = '';
                
            } catch (error) {
                alert('Streaming error: ' + error.message);
            } finally {
                streamButton.disabled = false;
                document.getElementById('streaming-indicator').style.display = 'none';
            }
        }
        
        function handleStreamData(data, fullResponse, savedUserInput) {
            if (data.error) {
                alert('Error: ' + data.error);
                return;
            }
            
            if (data.done) {
                // Capture prompts sent (if provided in streaming)
                if (data.prompts_sent) {
                    lastPromptsSent = data.prompts_sent;
                    console.log('Captured prompts from streaming:', lastPromptsSent);
                    // Update the rendered prompt display
                    updateRenderedPromptDisplay(data.prompts_sent);
                }
                
                // Update the raw response display with the complete response
                if (data.raw_response) {
                    document.getElementById('raw-response').textContent = data.raw_response;
                }
                
                // Get the assistant's response content
                let assistantContent = '';
                if (data.final_content) {
                    assistantContent = data.final_content;
                } else if (fullResponse) {
                    // Fallback: extract final content
                    assistantContent = extractFinalContent(fullResponse);
                }
                
                // Add both messages in correct chronological order
                if (savedUserInput && assistantContent) {
                    addMessagePair(savedUserInput, assistantContent);
                }
                
                // Handle parsed messages
                if (data.parsed_messages) {
                    displayParsedMessages(data.parsed_messages);
                }
                
                // Display tool calls if present
                if (data.tool_calls && data.tool_calls.length > 0) {
                    const toolCallsDiv = document.getElementById('tool-calls');
                    const toolCallsList = toolCallsDiv.querySelector('.tool-calls-list');
                    
                    toolCallsDiv.style.display = 'block';
                    toolCallsList.innerHTML = '';
                    
                    data.tool_calls.forEach((toolCall, index) => {
                        const toolDiv = document.createElement('div');
                        toolDiv.className = 'tool-call-item';
                        
                        toolDiv.innerHTML = `
                            <div class="tool-call-header">Tool Call ${index + 1}: ${toolCall.tool}</div>
                            <div class="tool-params">
                                <strong>Parameters:</strong><br>
                                ${JSON.stringify(toolCall.params, null, 2)}
                            </div>
                            <div class="tool-result">
                                <strong>Result:</strong><br>
                                ${JSON.stringify(toolCall.result, null, 2)}
                            </div>
                        `;
                        
                        toolCallsList.appendChild(toolDiv);
                    });
                }
                
                // Update conversation display
                updateConversationDisplay();
                
                document.getElementById('parsing-state').style.display = 'none';
                return;
            }
            
            // Handle tool execution notification
            if (data.tool_executed) {
                const toolCallsDiv = document.getElementById('tool-calls');
                const toolCallsList = toolCallsDiv.querySelector('.tool-calls-list');
                
                toolCallsDiv.style.display = 'block';
                
                // Check if this is a Python tool execution
                if (data.tool_executed.tool === 'functions.python' || data.tool_executed.tool === 'python') {
                    // Show Python info modal if first time
                    if (!sessionStorage.getItem('pythonExecuted')) {
                        showPythonInfo();
                        sessionStorage.setItem('pythonExecuted', 'true');
                    }
                }
                
                const toolDiv = document.createElement('div');
                toolDiv.className = 'tool-call-item';
                
                toolDiv.innerHTML = `
                    <div class="tool-call-header">Executing: ${data.tool_executed.tool}</div>
                    <div class="tool-params">
                        <strong>Parameters:</strong><br>
                        ${JSON.stringify(data.tool_executed.params, null, 2)}
                    </div>
                    <div class="tool-result">
                        <strong>Result:</strong><br>
                        ${JSON.stringify(data.tool_executed.result, null, 2)}
                    </div>
                `;
                
                toolCallsList.appendChild(toolDiv);
                return;
            }
            
            // Handle continuation notification
            if (data.continuing_after_tools) {
                // Silently continue - no need to show this status message
                return;
            }
            
            // Update parsing state
            if (data.current_role) {
                document.getElementById('current-role').textContent = data.current_role;
            }
            if (data.current_channel !== undefined) {
                document.getElementById('current-channel').textContent = data.current_channel || 'none';
            }
            if (data.current_recipient !== undefined) {
                document.getElementById('current-recipient').textContent = data.current_recipient || 'none';
            }
            if (data.current_content_type !== undefined) {
                document.getElementById('current-content-type').textContent = data.current_content_type || 'none';
            }
            
            // Update raw response
            if (data.accumulated) {
                document.getElementById('raw-response').textContent = data.accumulated;
            }
            
            // Update channel displays
            if (data.current_channel && data.current_content) {
                const channelDiv = document.getElementById(`${data.current_channel}-channel`);
                if (channelDiv) {
                    channelDiv.style.display = 'block';
                    const contentDiv = channelDiv.querySelector('div');
                    // Render markdown for final channel, preserve formatting for others
                    if (data.current_channel === 'final') {
                        contentDiv.innerHTML = renderMarkdown(data.current_content);
                    } else {
                        // Preserve line breaks and formatting for analysis/commentary
                        contentDiv.innerHTML = escapeHtml(data.current_content).replace(/\n/g, '<br>');
                    }
                }
            }
        }
        
        function displayParsedMessages(messages) {
            // Group messages by channel
            const channels = {};
            messages.forEach(msg => {
                const channel = msg.channel || 'default';
                if (!channels[channel]) {
                    channels[channel] = [];
                }
                channels[channel].push(msg.content);
            });
            
            // Display each channel
            Object.entries(channels).forEach(([channel, contents]) => {
                const channelDiv = document.getElementById(`${channel}-channel`);
                if (channelDiv) {
                    channelDiv.style.display = 'block';
                    const contentDiv = channelDiv.querySelector('div');
                    const combinedContent = contents.join('\n');
                    // Render markdown for final channel, preserve formatting for others
                    if (channel === 'final') {
                        contentDiv.innerHTML = renderMarkdown(combinedContent);
                    } else {
                        // Preserve line breaks and formatting for analysis/commentary
                        contentDiv.innerHTML = escapeHtml(combinedContent).replace(/\n/g, '<br>');
                    }
                }
            });
        }
        
        // Display response
        function displayResponse(data) {
            // Show raw response
            document.getElementById('raw-response').textContent = data.raw_response;
            
            // Clear channels
            document.querySelectorAll('#response-channels > div').forEach(div => {
                div.style.display = 'none';
                div.querySelector('div').textContent = '';
            });
            
            // Display parsed messages by channel
            if (data.parsed_messages) {
                Object.entries(data.parsed_messages).forEach(([channel, messages]) => {
                    const channelDiv = document.getElementById(`${channel}-channel`);
                    if (channelDiv) {
                        channelDiv.style.display = 'block';
                        const contentDiv = channelDiv.querySelector('div');
                        const combinedContent = messages.map(m => m.content).join('\n');
                        // Render markdown for final channel, preserve formatting for others
                        if (channel === 'final') {
                            contentDiv.innerHTML = renderMarkdown(combinedContent);
                        } else {
                            // Preserve line breaks and formatting for analysis/commentary
                            contentDiv.innerHTML = escapeHtml(combinedContent).replace(/\n/g, '<br>');
                        }
                    }
                });
            }
            
            // Display tool calls if present
            if (data.tool_calls && data.tool_calls.length > 0) {
                const toolCallsDiv = document.getElementById('tool-calls');
                const toolCallsList = toolCallsDiv.querySelector('.tool-calls-list');
                
                toolCallsDiv.style.display = 'block';
                toolCallsList.innerHTML = '';
                
                data.tool_calls.forEach((toolCall, index) => {
                    const toolDiv = document.createElement('div');
                    toolDiv.className = 'tool-call-item';
                    
                    toolDiv.innerHTML = `
                        <div class="tool-call-header">Tool Call ${index + 1}: ${toolCall.tool}</div>
                        <div class="tool-params">
                            <strong>Parameters:</strong><br>
                            ${JSON.stringify(toolCall.params, null, 2)}
                        </div>
                        <div class="tool-result">
                            <strong>Result:</strong><br>
                            ${JSON.stringify(toolCall.result, null, 2)}
                        </div>
                    `;
                    
                    toolCallsList.appendChild(toolDiv);
                });
            } else {
                document.getElementById('tool-calls').style.display = 'none';
            }
            
            // Update conversation display
            updateConversationDisplay();
        }
        
        // Update conversation display
        function updateConversationDisplay() {
            const historyDiv = document.getElementById('conversation-history');
            historyDiv.innerHTML = '';
            
            conversationHistory.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message message-${msg.role}`;
                
                // Handle different message structures
                let content = '';
                if (msg.role === 'user') {
                    content = msg.content;
                } else if (msg.role === 'assistant') {
                    // Assistant messages might have rawContent or parsedMessages
                    if (msg.rawContent) {
                        // Extract final channel content if available
                        if (msg.parsedMessages && msg.parsedMessages.final) {
                            content = msg.parsedMessages.final.map(m => m.content).join('\n');
                        } else {
                            // Try to extract final content from raw response
                            const finalMatch = msg.rawContent.match(/<\|channel\|>final<\|message\|>(.*?)(?:<\|return\|>|<\|end\|>|$)/s);
                            if (finalMatch) {
                                content = finalMatch[1].trim();
                            } else {
                                content = '[Processing...]';
                            }
                        }
                    } else {
                        content = msg.content || '[No content]';
                    }
                }
                
                // Render markdown for assistant messages in conversation history
                let displayContent;
                if (msg.role === 'assistant') {
                    // Assistant messages should have markdown rendered
                    displayContent = renderMarkdown(content);
                } else {
                    // User messages remain plain text
                    displayContent = escapeHtml(content);
                }
                
                messageDiv.innerHTML = `
                    <div class="message-header">${msg.role.toUpperCase()}</div>
                    <div class="message-content">${displayContent}</div>
                `;
                historyDiv.appendChild(messageDiv);
            });
        }
        
        // Clear conversation
        function clearConversation() {
            conversationHistory = [];
            updateConversationDisplay();
            updatePrompt();
        }
        
        // Show full prompt modal
        async function showFullPrompt() {
            const userInput = document.getElementById('user-input').value;
            const config = getConfiguration();
            config.current_message = userInput;
            
            // Add current timestamp
            const timestamp = new Date().toISOString();
            
            // Build the full request details
            const fullRequest = {
                endpoint: '/api/chat',
                timestamp: timestamp,
                next_request_preview: {
                    note: "This is what WOULD be sent if you click Send now",
                    payload: config,
                    conversation_history_details: conversationHistory.map((msg, idx) => ({
                        index: idx,
                        role: msg.role,
                        has_content: !!msg.content,
                        content_preview: msg.content ? msg.content.substring(0, 100) + '...' : 'N/A'
                    }))
                },
                last_request_sent: lastActualRequest || null,
                all_prompts_from_last_request: lastPromptsSent.length > 0 ? lastPromptsSent : null
            };
            
            // If we want to show what the NEXT prompt would look like
            if (config.current_message) {
                try {
                    const response = await fetch('/api/render_prompt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        fullRequest.next_request_preview.rendered_prompt = data.prompt;
                        fullRequest.next_request_preview.token_count = data.token_count;
                    }
                } catch (e) {
                    fullRequest.next_request_preview.render_error = e.toString();
                }
            }
            
            // Display in modal
            document.getElementById('prompt-json-display').textContent = JSON.stringify(fullRequest, null, 2);
            document.getElementById('promptModal').style.display = 'block';
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('promptModal').style.display = 'none';
        }
        
        // Python modal functions
        function showPythonInfo() {
            document.getElementById('pythonModal').style.display = 'block';
        }
        
        function closePythonModal() {
            document.getElementById('pythonModal').style.display = 'none';
        }
        
        function handlePythonToggle() {
            const pythonEnabled = document.getElementById('python-toggle').checked;
            if (pythonEnabled) {
                // Show info modal on first enable
                if (!sessionStorage.getItem('pythonModalShown')) {
                    showPythonInfo();
                    sessionStorage.setItem('pythonModalShown', 'true');
                }
                // Update default message
                const userInput = document.getElementById('user-input');
                if (userInput.value === 'What is the weather like today?' || userInput.value === '') {
                    userInput.value = 'Use the python tool to roll a D20 dice and tell me what I rolled.';
                }
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const promptModal = document.getElementById('promptModal');
            const pythonModal = document.getElementById('pythonModal');
            if (event.target == promptModal) {
                promptModal.style.display = 'none';
            } else if (event.target == pythonModal) {
                pythonModal.style.display = 'none';
            }
        }
        
        // Update the active tools display and prompt
        function updateToolsDisplay() {
            console.log('=== updateToolsDisplay called ===');
            
            // Update active tools display
            const activeTools = [];
            if (document.getElementById('weather-toggle').checked) {
                activeTools.push('🌤️ Weather (get_current_weather)');
            }
            if (document.getElementById('python-toggle').checked) {
                activeTools.push('🐍 Python');
            }
            if (document.getElementById('vision-browser-toggle').checked) {
                activeTools.push('🌐 Vision Browser');
            }
            if (document.getElementById('browser-toggle').checked) {
                activeTools.push('🔍 Built-in Browser');
            }
            
            const activeToolsDiv = document.getElementById('active-tools-display');
            if (activeToolsDiv) {
                if (activeTools.length === 0) {
                    activeToolsDiv.innerHTML = '<em style="color: #999;">No tools enabled</em>';
                } else {
                    activeToolsDiv.innerHTML = activeTools.join(' • ');
                }
            }
            
            updatePrompt();
        }
        
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved theme
            loadTheme();
            
            // Load saved settings
            loadSettings();
            
            // Set up tool toggle listeners
            document.getElementById('weather-toggle').addEventListener('change', updateToolsDisplay);
            document.getElementById('python-toggle').addEventListener('change', updateToolsDisplay);
            document.getElementById('vision-browser-toggle').addEventListener('change', updateToolsDisplay);
            
            // Update prompt when configuration changes
            document.querySelectorAll('input[type="text"], textarea, select').forEach(element => {
                // Skip tool toggle checkboxes as they have their own handlers
                if (element.id && (element.id.includes('-toggle'))) {
                    return;
                }
                element.addEventListener('change', updatePrompt);
            });
            
            // Add live preview update for tool inputs
            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('tool-name') || 
                    e.target.classList.contains('tool-description') || 
                    e.target.classList.contains('tool-parameters')) {
                    const toolElement = e.target.closest('.tool-definition');
                    if (toolElement) {
                        updateToolPreview(toolElement);
                    }
                }
            });
            
            // Initial display update
            updateToolsDisplay();
            
            // Initial tool preview
            updateAllToolPreviews();
            
            // Check server on load
            checkServer();
        });
    </script>
</body>
</html>